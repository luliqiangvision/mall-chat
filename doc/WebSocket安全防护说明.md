# WebSocket安全防护说明

## 概述
为了保护WebSocket聊天系统免受恶意攻击，我们实现了多层安全防护机制。

## 安全防护组件

### 1. WebSocketSecurityFilter - 内容安全过滤器
**功能：**
- 检测和阻止恶意脚本注入
- 过滤可疑链接和病毒文件
- 敏感词过滤
- 消息长度限制
- HTML标签清理

**防护内容：**
- `<script>` 标签和JavaScript代码
- `javascript:` 协议链接
- 事件处理器（onclick, onload等）
- `eval()` 和 `expression()` 函数
- 可疑文件扩展名（.exe, .bat, .cmd等）
- 短链接服务（bit.ly, tinyurl等）
- 敏感词汇（病毒、木马、赌博等）

### 2. WebSocketRateLimiter - 速率限制器
**功能：**
- 防止消息洪水攻击
- 限制用户发送频率
- 全局消息速率控制
- 自动清理过期数据

**限制规则：**
- 每分钟最多60条消息
- 每小时最多1000条消息
- 全局每分钟最多10000条消息
- 自动清理1小时未活跃的用户

### 3. WebSocketConnectionManager - 连接管理器
**功能：**
- 限制连接数量
- IP地址限制
- 会话验证
- 连接统计

**限制规则：**
- 每个用户最多3个连接
- 每个IP最多10个连接
- 系统总连接数最多10000个
- 会话ID与用户ID绑定验证

## 安全防护流程

### 连接建立时：
1. **用户认证** - 网关验证token并透传用户信息
2. **用户类型验证** - 确保客户和客服使用正确的处理器
3. **连接限制检查** - 验证用户和IP连接数限制
4. **会话注册** - 记录连接信息用于后续验证

### 消息处理时：
1. **会话验证** - 验证会话ID与用户ID的绑定关系
2. **速率限制** - 检查用户消息发送频率
3. **内容安全检查** - 检测恶意脚本、可疑链接、敏感词
4. **内容过滤** - 清理HTML标签和特殊字符
5. **消息转发** - 通过验证后转发给目标用户

### 连接关闭时：
1. **连接注销** - 清理连接计数和会话映射
2. **资源释放** - 释放相关资源

## 安全配置

### 可配置参数：
```java
// 消息长度限制
MAX_MESSAGE_LENGTH = 10000

// 速率限制
MAX_MESSAGES_PER_MINUTE = 60
MAX_MESSAGES_PER_HOUR = 1000
MAX_GLOBAL_MESSAGES_PER_MINUTE = 10000

// 连接限制
MAX_CONNECTIONS_PER_USER = 3
MAX_CONNECTIONS_PER_IP = 10
MAX_TOTAL_CONNECTIONS = 10000
```

### 定期任务：
- 每5分钟清理过期的用户速率信息
- 每10分钟输出连接统计信息

## 安全事件处理

### 检测到安全威胁时：
1. **记录日志** - 详细记录安全事件
2. **发送错误消息** - 向用户发送安全提示
3. **拒绝处理** - 不转发恶意消息
4. **连接管理** - 严重情况下可关闭连接

### 日志记录：
- 所有安全事件都会记录到日志
- 包含用户ID、IP地址、威胁类型、时间戳
- 便于安全分析和审计

## 扩展建议

### 1. 增强内容检测：
- 集成第三方安全服务
- 添加图片内容检测
- 实现语音内容分析

### 2. 行为分析：
- 异常行为检测
- 用户行为画像
- 风险评估模型

### 3. 实时监控：
- 安全事件实时告警
- 连接状态监控面板
- 性能指标监控

## 使用说明

### 开发者注意事项：
1. 所有安全组件都是自动生效的
2. 不需要手动调用安全检查方法
3. 安全配置可以通过修改常量值调整
4. 定期检查安全日志

### 运维注意事项：
1. 监控连接数和消息量
2. 关注安全事件日志
3. 定期更新安全规则
4. 备份安全配置

## 总结

通过多层安全防护机制，我们的WebSocket聊天系统能够有效防范：
- 脚本注入攻击
- 恶意链接传播
- 消息洪水攻击
- 连接资源耗尽
- 会话劫持
- 敏感信息泄露

这些安全措施确保了系统的稳定性和用户数据的安全性。
