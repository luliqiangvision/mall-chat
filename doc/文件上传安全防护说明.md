# 文件上传安全防护说明

## 概述
针对客服聊天系统的文件上传功能，实现了严格的安全防护机制，只允许图片、文字、视频文件，并进行魔数校验。

## 支持的文件类型

### 1. 图片文件
- **格式**: jpg, jpeg, png, gif, bmp, webp, svg
- **大小限制**: 最大20MB
- **魔数校验**: 严格验证文件头魔数

### 2. 文字文件
- **格式**: txt, md, rtf
- **大小限制**: 最大10KB（约200字）
- **内容校验**: 检查是否为可打印字符

### 3. 视频文件
- **格式**: mp4, avi, mov, wmv, flv, webm, mkv
- **大小限制**: 最大100MB
- **魔数校验**: 验证视频文件头

## 安全防护机制

### 1. 文件类型白名单
```java
// 只允许以下文件类型
"jpg", "jpeg", "png", "gif", "bmp", "webp", "svg",  // 图片
"txt", "md", "rtf",                                  // 文字
"mp4", "avi", "mov", "wmv", "flv", "webm", "mkv"    // 视频
```

### 2. 严格魔数校验
每种文件类型都有对应的魔数验证：

#### 图片文件魔数
- **JPEG**: `FF D8 FF`
- **PNG**: `89 50 4E 47 0D 0A 1A 0A`
- **GIF**: `47 49 46 38 37/39 61`
- **BMP**: `42 4D`
- **WebP**: `52 49 46 46 ... 57 45 42 50`
- **SVG**: `3C 3F 78 6D 6C` (<?xml)

#### 视频文件魔数
- **MP4**: `ftyp` 或 `00 00 00 18 66 74 79 70`
- **AVI**: `52 49 46 46 ... 41 56 49 20` (RIFF...AVI )
- **MOV**: `ftyp ... qt`
- **WMV**: `30 26 B2 75 8E 66 CF 11`
- **FLV**: `46 4C 56 01` (FLV)
- **WebM/MKV**: `1A 45 DF A3`

#### 文字文件校验
- **TXT/MD**: 检查90%以上为可打印字符
- **RTF**: `7B 5C 72 74 66` ({\rtf)

### 3. 文件大小限制
- **图片**: 最大20MB
- **文字**: 最大10KB（约200字）
- **视频**: 最大100MB
- **总体**: 最大100MB

### 4. 病毒扫描
- 集成ClamAV杀毒引擎
- 支持异步扫描
- 扫描超时保护
- 模拟扫描模式（测试用）

### 5. 存储安全
- 临时存储区隔离
- 扫描通过后移动到正式存储
- 带签名的下载链接
- 自动清理临时文件

## 上传流程

### 同步上传（小文件）
1. **基础安全检查** - 文件类型、大小、魔数校验
2. **病毒扫描** - ClamAV扫描
3. **存储文件** - 保存到正式目录
4. **返回结果** - 生成访问URL

### 异步上传（大文件）
1. **基础安全检查** - 文件类型、大小、魔数校验
2. **临时存储** - 保存到临时目录
3. **异步扫描** - 后台病毒扫描
4. **结果处理** - 扫描通过后移动到正式目录

## 安全事件处理

### 检测到威胁时
1. **记录日志** - 详细记录安全事件
2. **拒绝上传** - 返回错误信息
3. **清理文件** - 删除临时文件
4. **用户提示** - 友好的错误提示

### 日志记录
- 文件上传尝试
- 安全检查结果
- 病毒扫描结果
- 存储操作结果

## 配置说明

### 应用配置
```yaml
chat:
  file:
    storage-path: /data/chat/files
    temp-path: /data/chat/temp
    base-url: http://localhost:8080/chat/file
    
  virus-scan:
    enabled: true
    engine: clamav
    timeout: 30
```

### 系统要求
- ClamAV杀毒引擎
- 足够的磁盘空间
- 网络访问权限

## 使用示例

### 上传接口
```http
POST /chat/file/upload
Content-Type: multipart/form-data

file: [文件]
userId: 用户ID
toUserId: 接收者ID
messageType: file
```

### 响应格式
```json
{
  "success": true,
  "message": "文件上传成功",
  "fileUrl": "http://localhost:8080/chat/file/2024/01/15/user123/uuid.jpg",
  "fileName": "image.jpg",
  "fileSize": 1024000,
  "chatMessage": {
    "type": "file",
    "fromUserId": "user123",
    "toUserId": "service456",
    "content": "image.jpg",
    "timestamp": "2024-01-15T10:30:00"
  }
}
```

## 安全优势

1. **严格类型控制** - 只允许安全的文件类型
2. **魔数验证** - 防止文件伪装
3. **大小限制** - 防止大文件攻击
4. **病毒扫描** - 实时威胁检测
5. **隔离存储** - 沙箱式文件处理
6. **审计日志** - 完整的操作记录

## 总结

通过多层安全防护机制，确保客服聊天系统的文件上传功能安全可靠：
- 只允许图片、文字、视频文件
- 严格的魔数校验防止文件伪装
- 合理的文件大小限制
- 实时病毒扫描
- 安全的存储和访问机制

这些措施有效防范了文件上传相关的安全威胁，保护了系统和用户的安全。
