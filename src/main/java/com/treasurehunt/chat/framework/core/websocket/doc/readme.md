å¥½é—®é¢˜ï¼Œè€Œä¸”ä½ æŠ“å¾—éå¸¸å‡†ï¼š
**HTTP åè®®å±‚æœ‰ headerã€methodã€URIã€body ç­‰æ ‡å‡†å­—æ®µï¼›
é‚£ WebSocket åœ¨åè®®å±‚æ˜¯å¦ä¹Ÿæœ‰â€œHeaderâ€ã€â€œMethodâ€ã€â€œPathâ€ç­‰ï¼Ÿ**

ç­”æ¡ˆæ˜¯ï¼š
â¡ï¸ **WebSocket åœ¨åè®®å±‚ï¼ˆRFC 6455ï¼‰åªæœ‰ä¸€æ¬¡æ¡æ‰‹æœ‰ HTTP headerï¼Œæ¡æ‰‹å®Œæˆåä¼ è¾“é˜¶æ®µæ˜¯â€œçº¯å¸§ç»“æ„â€ï¼Œå†ä¹Ÿæ²¡æœ‰ header æ¦‚å¿µã€‚**

---

## ğŸ”¹ ä¸€ã€åè®®åˆ†ä¸¤å±‚çœ‹

| é˜¶æ®µ           | åè®®å±‚                 | å†…å®¹                                                                                                           |
| ------------ | ------------------- | ------------------------------------------------------------------------------------------------------------ |
| **1. æ¡æ‰‹é˜¶æ®µ**  | **HTTP åè®®**         | å®¢æˆ·ç«¯ç”¨ HTTP è¯·æ±‚å‘èµ·å‡çº§ (`Upgrade: websocket`)ï¼Œè¿™é‡Œç¡®å®æœ‰ HTTP headerï¼Œä¾‹å¦‚ï¼š`Host`ã€`Sec-WebSocket-Key`ã€`Origin` ç­‰ã€‚          |
| **2. æ•°æ®å¸§é˜¶æ®µ** | **WebSocket è‡ªèº«å¸§åè®®** | æ¡æ‰‹å®Œæˆåï¼Œè¿›å…¥â€œå¸§ä¼ è¾“â€æ¨¡å¼ï¼ˆFrameï¼‰ï¼Œå¸§å¤´éƒ¨åªæœ‰ `FIN`ã€`opcode`ã€`mask`ã€`payload length`ã€`masking-key`ï¼Œ**æ²¡æœ‰ header æˆ– method æ¦‚å¿µ**ã€‚ |

---

## ğŸ”¹ äºŒã€æ¡æ‰‹é˜¶æ®µï¼ˆHTTP Headersï¼‰

å®¢æˆ·ç«¯å‘èµ·çš„æ¡æ‰‹è¯·æ±‚ç¤ºä¾‹ï¼š

```
GET /chat HTTP/1.1
Host: example.com:8000
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
Origin: https://example.com
```

æœåŠ¡å™¨å“åº”ï¼š

```
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
```

è¿™éƒ¨åˆ†å®Œå…¨æ˜¯ HTTP å±‚çš„ headerã€‚
æ¡æ‰‹æˆåŠŸåï¼ŒTCP é€šé“è¢«å‡çº§ï¼Œè¿›å…¥å…¨åŒå·¥å¸§æ¨¡å¼ã€‚

---

## ğŸ”¹ ä¸‰ã€æ•°æ®å¸§é˜¶æ®µï¼ˆWebSocket Frameï¼‰

RFC 6455 å®šä¹‰çš„æ•°æ®å¸§ç»“æ„å¦‚ä¸‹ï¼š

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |            (16/64)            |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+-------------------------------+
| Masking-key (32) (if MASK set)                               |
+-------------------------------+-------------------------------+
| Payload Data (x bytes) ...                                   |
+---------------------------------------------------------------+
```

å­—æ®µè¯´æ˜ï¼š

| å­—æ®µ                 | ä½æ•°          | å«ä¹‰                                         |
| ------------------ | ----------- | ------------------------------------------ |
| **FIN**            | 1           | æ˜¯å¦æ˜¯æ¶ˆæ¯æœ€åä¸€å¸§                                  |
| **RSV1â€“3**         | 3           | æ‰©å±•ä¿ç•™ä½                                      |
| **opcode**         | 4           | æ“ä½œç ï¼š1=textã€2=binaryã€8=closeã€9=pingã€10=pong |
| **MASK**           | 1           | æ˜¯å¦æœ‰æ©ç ï¼ˆå®¢æˆ·ç«¯â†’æœåŠ¡ç«¯å¿…é¡»æœ‰ï¼‰                          |
| **Payload length** | 7/7+16/7+64 | æ•°æ®é•¿åº¦                                       |
| **Masking key**    | 32          | æ©ç é”®ï¼ˆå®¢æˆ·ç«¯å‘å¿…é¡»ï¼‰                                |
| **Payload data**   | n           | å®é™…å†…å®¹ï¼ˆæ–‡æœ¬æˆ–äºŒè¿›åˆ¶ï¼‰                               |

ğŸ‘‰ è¿™å°±æ˜¯â€œå¸§å±‚ headerâ€ï¼Œå®ƒåªè´Ÿè´£**æ§åˆ¶ä¼ è¾“**ï¼Œå¹¶ä¸æºå¸¦åº”ç”¨çº§å…ƒä¿¡æ¯ã€‚
æ‰€ä»¥ï¼š

* æ²¡æœ‰ HTTP headerï¼›
* æ²¡æœ‰ pathï¼›
* æ²¡æœ‰ methodï¼›
* payload æ˜¯çº¯å­—èŠ‚æµï¼ˆæ–‡æœ¬æˆ–äºŒè¿›åˆ¶ï¼‰ã€‚

---

## ğŸ”¹ å››ã€ä¸ºä»€ä¹ˆæ²¡æœ‰â€œåè®®çº§ headerâ€

å› ä¸º WebSocket çš„è®¾è®¡ç›®æ ‡æ˜¯ï¼š

> â€œæä¾›ä¸€æ¡æŒä¹…çš„ã€ä½å¼€é”€çš„ã€åŒå‘é€šä¿¡é€šé“ã€‚â€

å®ƒå‡è®¾åº”ç”¨å±‚è‡ªå·±å®šä¹‰æ¶ˆæ¯æ ¼å¼ã€‚
æ‰€ä»¥ä½ çœ‹åˆ°ï¼š

* **STOMP over WebSocket**ï¼šè‡ªå·±åŠ ä¸Š `destination:`ã€`content-type:` ç­‰å¤´ï¼›
* **GraphQL-WS**ï¼šè‡ªå·±å®šä¹‰ `type: start / stop / data`ï¼›
* **Socket.IO**ï¼šè‡ªå·±å®šä¹‰äº‹ä»¶åå’Œå‘½åç©ºé—´ï¼›
* **Spring Messaging**ï¼šå°è£…æˆ `SimpMessageHeaderAccessor`ã€‚

â¡ï¸ è¿™äº›éƒ½ä¸æ˜¯ RFC çš„å†…å®¹ï¼Œè€Œæ˜¯**åº”ç”¨å±‚åè®®è‡ªå·±å®šä¹‰çš„â€œä¼ª headerâ€**ã€‚

---

## ğŸ”¹ äº”ã€å¦‚æœä½ è¦â€œæ¨¡æ‹Ÿ HTTP è¯­ä¹‰â€

ä½ å®Œå…¨å¯ä»¥è‡ªå·±åœ¨ payload å±‚å®šä¹‰ header åŒºåŸŸã€‚ä¾‹å¦‚ï¼š

### æ–‡æœ¬å¸§ï¼ˆJSONï¼‰ï¼š

```json
{
  "headers": {
    "Authorization": "Bearer xxx",
    "User-Agent": "ws-client/1.0"
  },
  "method": "POST",
  "path": "/chat/send",
  "body": {
    "text": "hello"
  }
}
```

### äºŒè¿›åˆ¶å¸§ï¼ˆè‡ªå®šä¹‰ç»“æ„ï¼‰ï¼š

```
[HeaderLength(2 bytes)][Header(JSON)][Body(Bytes)]
```

è¿™æ ·ä½ çš„ `WebSocketRequest` å°±åƒæ˜¯ `HttpServletRequest` çš„å°è£…ä½“ã€‚

---

## ğŸ”¹ å…­ã€æ€»ç»“å¯¹æ¯”è¡¨

| å±‚çº§           | HTTP                                 | WebSocket                    |
| ------------ | ------------------------------------ | ---------------------------- |
| æ¡æ‰‹           | HTTP header å­˜åœ¨                       | åŒæ ·ä½¿ç”¨ HTTP headerï¼ˆä»…æ¡æ‰‹æ—¶ï¼‰       |
| æ•°æ®ä¼ è¾“         | æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çš„ HTTP æŠ¥æ–‡ï¼ˆå¸¦ headerï¼‰            | æŒä¹…è¿æ¥å¸§ç»“æ„ï¼Œæ—  header             |
| åº”ç”¨å±‚æ‰©å±•        | ä¸éœ€è¦ï¼ˆHTTP å·²å®šä¹‰ï¼‰                        | **å¿…é¡»è‡ªå®šä¹‰**ï¼ˆJSON/STOMP/WAMP ç­‰ï¼‰ |
| å…¸å‹ header ç¤ºä¾‹ | Host, Content-Type, Authorization    | æ— ï¼ˆåº”ç”¨å±‚è‡ªè¡Œå®šä¹‰ï¼‰                   |
| å¯¹åº”ç±»          | `HttpServletRequest` / `HttpHeaders` | è‡ªå®šä¹‰ `WebSocketRequest`       |

---

âœ… **æœ€ç»ˆç»“è®ºï¼š**

* WebSocket åªæœ‰æ¡æ‰‹æ—¶ç”¨ HTTP headerï¼›
* æ¡æ‰‹åæ˜¯**çº¯äºŒè¿›åˆ¶å¸§åè®®**ï¼Œæ— åº”ç”¨å±‚ header æ¦‚å¿µï¼›
* æ‰€ä»¥æ¡†æ¶ï¼ˆåŒ…æ‹¬ Springï¼‰éƒ½ä¼šåœ¨**åº”ç”¨å±‚è‡ªè¡Œå°è£…ä¸€ä¸ªâ€œä¼ªåè®®å±‚â€**ï¼ˆå³ä½ å†™çš„ `WebSocketRequest`ï¼‰ã€‚

---

å¦‚æœä½ æƒ³çœ‹**RFC 6455**çš„å¸§å¤´äºŒè¿›åˆ¶å›¾æˆ– **Spring çš„ STOMP over WebSocket æŠ¥æ–‡ä¾‹å­**ï¼Œæˆ‘å¯ä»¥æŠŠä¸¤è€…å¹¶æ’ç”»å‡ºæ¥ç»™ä½ çœ‹ï¼Œå¯¹æ¯”â€œåŸç”Ÿ WebSocket å¸§â€å’Œâ€œå¸¦ header çš„ STOMP å¸§â€ã€‚æ˜¯å¦è¦æˆ‘ç”»ï¼Ÿ
